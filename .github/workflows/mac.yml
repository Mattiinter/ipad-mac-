name: Mac_Sequoia_iPad_Localtonet
on: workflow_dispatch
jobs:
  run-mac:
    runs-on: macos-latest
    steps:
      - name: 1. Setup Utente e VNC Nativo
        run: |
          # Creiamo l'utente 'ipad' con password '1234'
          sudo dscl . -create /Users/ipad
          sudo dscl . -create /Users/ipad UserShell /bin/bash
          sudo dscl . -create /Users/ipad UniqueID "601"
          sudo dscl . -create /Users/ipad PrimaryGroupID 20
          sudo dscl . -create /Users/ipad NFSHomeDirectory /Users/ipad
          sudo dscl . -passwd /Users/ipad 1234
          sudo dscl . -append /Groups/admin GroupMembership ipad

          # Attivazione Screen Sharing originale Apple
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -clientopts -setvncpasswd -vncpasswd 1234 -restart -agent -privs -all
          
      - name: 2. Avvio Tunnel Localtonet
        run: |
          # Scarichiamo il client ufficiale per Mac ARM64
          curl -L https://localtonet.com/download/localtonet-macos-arm64.zip -o localtonet.zip
          unzip localtonet.zip
          chmod +x localtonet
          
          # Avviamo il tunnel in modalità anonima (gratis e senza carta)
          # Il comando rimarrà attivo e mostrerà l'indirizzo nei log
          ./localtonet authtoken anonymous
          ./localtonet tcp --port 5900
