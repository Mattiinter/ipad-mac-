name: Mac_Sequoia_Final_iPad
on: workflow_dispatch
jobs:
  run-mac:
    runs-on: macos-latest
    steps:
      - name: 1. Sblocco Sicurezza Sequoia e VNC
        run: |
          # Creiamo un nuovo utente 'ipad' (evitiamo l'utente runner protetto)
          sudo dscl . -create /Users/ipad
          sudo dscl . -create /Users/ipad UserShell /bin/bash
          sudo dscl . -create /Users/ipad UniqueID "601"
          sudo dscl . -create /Users/ipad PrimaryGroupID 20
          sudo dscl . -create /Users/ipad NFSHomeDirectory /Users/ipad
          sudo dscl . -passwd /Users/ipad 1234
          sudo dscl . -append /Groups/admin GroupMembership ipad

          # Attivazione VNC Nativo con permessi forzati per macOS 15
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -clientopts -setvncpasswd -vncpasswd 1234 -restart -agent -privs -all
          
      - name: 2. Tunnel Ngrok (Molto più stabile di Bore su Sequoia)
        run: |
          # Installiamo ngrok
          brew install ngrok/ngrok/ngrok
          
          # NOTA: Per usare ngrok devi aggiungere il tuo token gratuito qui sotto.
          # Vai su ngrok.com, registrati e prendi il token (è gratis).
          # Sostituisci 'IL_TUO_TOKEN_QUI' con quello vero.
          ngrok config add-authtoken IL_TUO_TOKEN_QUI
          
          # Avviamo il tunnel sulla porta 5900
          ngrok tcp 5900
