name: Mac_iPad_TigerVNC_Final
on: workflow_dispatch
jobs:
  run-mac:
    runs-on: macos-latest
    steps:
      - name: 1. Setup Utente ipad
        run: |
          # Crea utente ipad con password 1234
          sudo dscl . -create /Users/ipad
          sudo dscl . -create /Users/ipad UserShell /bin/bash
          sudo dscl . -create /Users/ipad UniqueID "502"
          sudo dscl . -create /Users/ipad PrimaryGroupID 20
          sudo dscl . -create /Users/ipad NFSHomeDirectory /Users/ipad
          sudo dscl . -passwd /Users/ipad 1234
          sudo dscl . -append /Groups/admin GroupMembership ipad

      - name: 2. Installazione e Avvio TigerVNC
        run: |
          # Installazione corretta (usiamo tiger-vnc che include il server)
          brew install tiger-vnc
          
          # Creazione password VNC (minimo 6 caratteri: 123456)
          # Usiamo il percorso completo per evitare 'command not found'
          mkdir -p ~/.vnc
          printf "123456\n123456\nn\n" | /usr/local/opt/tiger-vnc/bin/vncpasswd
          
          # Avvio del server TigerVNC sulla porta 5900
          # Ignora i blocchi Apple sulla registrazione schermo
          /usr/local/opt/tiger-vnc/bin/vncserver :1 -rfbport 5900 -localhost no -geometry 1280x800
          
      - name: 3. Avvio Tunnel Bore
        run: |
          curl -L https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-apple-darwin.tar.gz | tar -xz
          ./bore local 5900 --to bore.pub
