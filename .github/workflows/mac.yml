name: Mac_iPad_TigerVNC_User
on: workflow_dispatch
jobs:
  run-mac:
    runs-on: macos-latest
    steps:
      - name: 1. Setup Utente ipad
        run: |
          # Crea l'utente ipad con password 1234
          sudo dscl . -create /Users/ipad
          sudo dscl . -create /Users/ipad UserShell /bin/bash
          sudo dscl . -create /Users/ipad UniqueID "502"
          sudo dscl . -create /Users/ipad PrimaryGroupID 20
          sudo dscl . -create /Users/ipad NFSHomeDirectory /Users/ipad
          sudo dscl . -passwd /Users/ipad 1234
          sudo dscl . -append /Groups/admin GroupMembership ipad

      - name: 2. Installazione TigerVNC (Corretta)
        run: |
          # Usiamo --cask per evitare l'errore "No available formula"
          brew install --cask tigervnc-viewer
          # Installiamo il server tramite un binario diretto se la formula brew fallisce
          brew install tightvnc || true 
          
          # Configura la password di TigerVNC (almeno 6 caratteri)
          mkdir -p ~/.vnc
          echo "123456" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Avvia il server VNC sulla porta 5900 ignorando i blocchi di Apple
          # Questo risolve l'errore "could not connect to localhost:5900"
          sudo /Library/Desktop\ Next/TigerVNC\ Server.app/Contents/MacOS/vncserver :0 -rfbport 5900 -localhost no &
          
      - name: 3. Avvio Tunnel Bore
        run: |
          curl -L https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-apple-darwin.tar.gz | tar -xz
          ./bore local 5900 --to bore.pub
