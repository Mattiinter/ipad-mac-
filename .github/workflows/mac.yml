name: Mac_iPad_Final_Force
on: workflow_dispatch
jobs:
  run-mac:
    runs-on: macos-latest
    steps:
      - name: 1. Setup Utente ipad
        run: |
          sudo dscl . -create /Users/ipad
          sudo dscl . -passwd /Users/ipad 1234
          sudo dscl . -append /Groups/admin GroupMembership ipad

      - name: 2. Installazione e Avvio Forzato VNC (No-Brew Path)
        run: |
          # Installiamo un server VNC alternativo tramite brew ma lo chiamiamo col percorso diretto
          brew install x11vnc
          
          # Creiamo la password VNC
          mkdir -p ~/.vnc
          x11vnc -storepasswd 123456 ~/.vnc/passwd
          
          # Avviamo il server forzando l'ascolto su TUTTE le interfacce sulla porta 5900
          # Questo risolve l'errore "could not connect to localhost:5900"
          sudo x11vnc -auth guess -forever -loop -noxdamage -repeat -rfbauth ~/.vnc/passwd -rfbport 5900 -shared -bg

      - name: 3. Avvio Tunnel Bore
        run: |
          curl -L https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-apple-darwin.tar.gz | tar -xz
          ./bore local 5900 --to bore.pub
