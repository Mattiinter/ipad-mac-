name: Mac_iPad_Screen_Fix
on: workflow_dispatch
jobs:
  run-mac:
    runs-on: macos-latest
    steps:
      - name: 1. Sblocco Privacy e Utente ipad
        run: |
          # Crea utente ipad
          sudo dscl . -create /Users/ipad
          sudo dscl . -passwd /Users/ipad 1234
          sudo dscl . -append /Groups/admin GroupMembership ipad
          
          # FORZA i permessi di registrazione schermo nel database TCC di sistema
          # Questo serve a eliminare l'errore "Screen recording might be disabled"
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','com.apple.RemoteManagement.ScreensharingAgent',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,1677555200);"
          
          # Attiva VNC con i privilegi corretti
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -clientopts -setvncpasswd -vncpasswd 1234 -restart -agent -privs -all

      - name: 2. Avvio Tunnel Bore
        run: |
          curl -L https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-apple-darwin.tar.gz | tar -xz
          ./bore local 5900 --to bore.pub
